homeassistant:
  name: !secret ha-name
  unit_system: imperial
  time_zone: !secret ha-timezone
  customize: !include customize.yaml

http:
  cors_allowed_origins:
    - https://google.com
    - https://www.home-assistant.io
    - http://cdn.clustrmaps.com

mqtt:
  broker: core-mosquitto
  username: username
  password: password
  
frontend:
  extra_html_url:
    - http://clustrmaps.com/map_v2.png?cl=ffffff&w=a&t=n&d=xr2Q2vt76X42HBH3uchXdk6LOOAJDVqAySTTK3bDWsM
    # - http://cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=a&t=n&d=xr2Q2vt76X42HBH3uchXdk6LOOAJDVqAySTTK3bDWsM

recorder:
  purge_keep_days: 1
  purge_interval: 1
  exclude:
    domains:
      - automation
      - updater
    entities:
      - sun.sun

system_health:

logger:
  default: error
  logs:
    homeassistant.core: fatal
    homeassistant.components.mqtt: warn

hassio:
cloud:
config:
updater:
conversation:
logbook:
map:
sun:
tts:
  - platform: google_translate
    service_name: google_say
  
history: !include history.yaml
group: !include groups.yaml
automation: !include automations.yaml

influxdb:
  host: a0d7b954-influxdb
  port: 8086
  database: homeassistant
  username: homeassistant
  password: !secret influxdb-password
  max_retries: 3
  default_measurement: state

sensor host_ip:
  - platform: command_line
    command: echo '{"date":'$(date "+%s")',"hostname":"'$(hostname)'","ipv4":"'$(ip addr | egrep "global" | sed "s/.* \([0-9\.]*\)\/.*/\1/" | head -1)'"}'
    name: host_ip
    scan_interval: 14400
    command_timeout: 10
    json_attributes:
      - date
      - hostname
      - ipv4
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.date | int | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}null{%- endif -%}
      
panel_iframe:
  netdata:
    title: NetData
    icon: mdi:chart-line
    url: !secret netdata
  hznmonitor:
    title: HZN monitor
    icon: mdi:factory
    url: !secret hznmonitor 
  grafana:
    title: Grafana
    icon: mdi:chart-timeline
    url: !secret grafana-url
    
## INPUT BOOLEAN(s)
input_boolean:
  # MOTION
  motion_event_notify:
    name: motion_event_notify
    initial: true
    icon: mdi:switch
  motion_status_notify:
    name: motion_status_notify
    initial: true
    icon: mdi:switch

## COUNTERS
counter:
  cpu2msghub_event_counter:
    name: cpu2msghub_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  sdr2msghub_event_counter:
    name: sdr2msghub_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  yolo2msghub_event_counter:
    name: yolo2msghub_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  startup_event_counter:
    name: startup_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  internet_test_counter:
    name: internet_test_counter
    initial: 0
    step: 1
    icon: mdi:counter
  hznsetup_event_counter:
    name: hznsetup_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  motion_event_counter:
    name: motion_event_counter
    initial: 0
    step: 1
    icon: mdi:counter
  motion_event_image_counter:
    name: motion_event_image_counter
    initial: 0
    step: 1
    icon: mdi:counter
 
## WEBLINKS
weblink:
  entities:
    # this site
    - name: this_site
      url: https://github.com/dcmartin/horizon.dcmartin.com/blob/master/README.md
      icon: mdi:source-repository
    # hassio-addons
    - name: sdr2msghub_addon
      url: https://github.com/dcmartin/hassio-addons/blob/master/sdr2msghub/README.md
      icon: mdi:radio
    - name: cpu2msghub_addon
      url: https://github.com/dcmartin/hassio-addons/blob/master/cpu2msghub/README.md
      icon: mdi:chip
    - name: kafka2mqtt4yolo_addon
      url: https://github.com/dcmartin/hassio-addons/blob/master/kafka2mqtt4yolo/README.md
      icon: mdi:message-text-outline
    # examples
    - name: sdr2msghub
      url: https://github.com/open-horizon/examples/tree/master/edge/msghub/sdr2msghub
      icon: mdi:radio
    - name: cpu2msghub
      url: https://github.com/open-horizon/examples/blob/master/edge/msghub/cpu2msghub/README.md
      icon: mdi:chip
    # open-horizon patterns
    - name: yolo2msghub
      url: https://github.com/dcmartin/open-horizon/blob/master/yolo2msghub/README.md
      icon: mdi:glasses
    - name: motion2mqtt
      url: https://github.com/dcmartin/open-horizon/blob/master/motion2mqtt/README.md
      icon: mdi:video
    - name: hznsetup
      url: https://github.com/dcmartin/open-horizon/blob/master/hznsetup/README.md/
      icon: mdi:hospital-building
    - name: startup
      url: https://github.com/dcmartin/open-horizon/blob/master/startup/README.md/
      icon: mdi:baby
    # open-horizon services
    - name: hznmonitor
      url: https://github.com/dcmartin/open-horizon/blob/master/hznmonitor/README.md/
      icon: mdi:factory
    - name: yolo
      url: https://github.com/dcmartin/open-horizon/blob/master/yolo/README.md/
      icon: mdi:eye
    - name: yolo4motion
      url: https://github.com/dcmartin/open-horizon/blob/master/yolo4motion/README.md/
      icon: mdi:comment-eye-outline
    - name: wan
      url: https://github.com/dcmartin/open-horizon/blob/master/wan/README.md/
      icon: mdi:wan
    - name: cpu
      url: https://github.com/dcmartin/open-horizon/blob/master/cpu/README.md/
      icon: mdi:percent
    - name: hal
      url: https://github.com/dcmartin/open-horizon/blob/master/hal/README.md/
      icon: mdi:desktop-classic
    - name: mqtt
      url: https://github.com/dcmartin/open-horizon/blob/master/mqtt/README.md/
      icon: mdi:mmessage-text
    - name: mqtt2kafka
      url: https://github.com/dcmartin/open-horizon/blob/master/mqtt2kafka/README.md/
      icon: mdi:message-text-outline
    - name: alpha
      url: http://horizon.dcmartin.com:8123
      icon: mdi:link
    - name: staging
      url: http://staging.dcmartin.com:8123
      icon: mdi:link
    - name: edgex
      url: http://edgex.dcmartin.com:8500/ui
      icon: mdi:link
    
## INPUT NUMBER(s)
input_number:
  # META
  client_update_interval:
    name: client update interval
    mode: slider
    initial: 30
    min: 5
    max: 900
    step: 5
    icon: mdi:timer
  # STARTUP
  startup_client_deviation:
    name: startup client deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  startup_average_deviation:
    name: startup average deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  startup_download_deviation:
    name: startup download deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  startup_measurement_deviation:
    name: startup measurement deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  # YOLO
  yolo2msghub_client_deviation:
    name: yolo2msghub client deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  yolo2msghub_detected_deviation:
    name: yolo2msghub detected deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  # SDR
  sdr2msghub_confidence:
    name: Confidence
    mode: slider
    initial: 0
    min: 0
    max: 1
    step: 0.01
    icon: mdi:target
  sdr2msghub_relevance:
    name: Relevance
    mode: slider
    initial: 0
    min: 0
    max: 1
    step: 0.01
    icon: mdi:target
  # INTERNET
  internet_deviation:
    name: Internet deviation
    mode: slider
    initial: 1.5
    min: 0.1
    max: 3
    step: 0.1
    icon: mdi:sigma-lower
  # HORIZON
  hznsetup_event_nodes_index:
    name: Node index
    mode: slider
    initial: 1
    min: 1
    max: 10
    step: 1
    
## HISTORY GRAPH(s
history_graph:
  ## STARTUP
  startup_events_count:
    name: startup_events_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.startup_events_count
  # ago
  startup_event_ago:
    name: startup_event_ago
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.startup_event_ago_min_value
      - sensor.startup_event_ago_max_value
      - sensor.startup_event_ago_mean
  # average containers
  startup_container_average:
    name: startup_container_average
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.startup_container_latest_average
      - sensor.startup_container_average_mean
      - sensor.startup_container_average_max_value
      - sensor.startup_container_average_min_value
      - sensor.startup_container_average_stdev_mean
      - sensor.startup_container_average_standard_deviation
  startup_download:
    name: startup_download
    hours_to_show: 2
    refresh: 30
    entities:
#     - sensor.startup_latest_download
      - sensor.startup_download_mean
      - sensor.startup_download_max_value
      - sensor.startup_download_min_value
      - sensor.startup_download_stdev_mean
      - sensor.startup_download_standard_deviation
  startup_measurement:
    name: startup_measurement
    hours_to_show: 2
    refresh: 30
    entities:
#     - sensor.startup_latest_measurement
      - sensor.startup_measurement_mean
      - sensor.startup_measurement_max_value
      - sensor.startup_measurement_min_value
      - sensor.startup_measurement_stdev_mean
      - sensor.startup_measurement_standard_deviation
  startup_percent:
    name: startup_percent
    hours_to_show: 2
    refresh: 30 
    entities:
#     - sensor.startup_latest_percent
      - sensor.startup_percent_mean
      - sensor.startup_percent_max_value
      - sensor.startup_percent_min_value
      - sensor.startup_percent_stdev_mean
      - sensor.startup_percent_standard_deviation
  # count of client
  startup_client_count:
    name: startup_client_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.horizon_organization_nodes_count
      - sensor.startup_client_count
      - sensor.startup_client_count_mean
      - sensor.startup_client_count_stdev_mean
      - sensor.startup_client_count_standard_deviation
  # percent of client
  startup_client_percent:
    name: startup_client_percent
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.startup_client_percent
      - sensor.startup_client_percent_mean
      - sensor.startup_client_percent_stdev_mean
      - sensor.startup_client_percent_standard_deviation
  # product ratio
  startup_product_ratio:
    name: startup_product_ratio
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.startup_product_ratio_cloudvm
      - sensor.startup_product_ratio_nano
      - sensor.startup_product_ratio_rpi3bp
      - sensor.startup_product_ratio_rpi3b
      - sensor.startup_product_ratio_tx2
      - sensor.startup_product_ratio_virtualbox
      - sensor.startup_product_ratio_other
  ## YOLO
  # count
  yolo2msghub_events_count:
    name: yolo2msghub_events_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_events_count
  # ago
  yolo2msghub_event_ago:
    name: yolo2msghub_event_ago
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_event_ago_mean
      - sensor.yolo2msghub_event_ago_max_value
      - sensor.yolo2msghub_event_ago_min_value
  # entity detected
  yolo2msghub_entity_detected:
    name: yolo2msghub_entity_detected
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_entity_detected_mean
      - sensor.yolo2msghub_entity_detected_max_value
      - sensor.yolo2msghub_entity_detected_min_value
  yolo2msghub_detected_stdev:
    name: yolo2msghub_detected_stdev
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_entity_detected_stdev_mean
      - sensor.yolo2msghub_entity_detected_standard_deviation
  yolo2msghub_entity_seen:
    name: yolo2msghub_entity_seen
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_entity_seen_count
  # any activity
  yolo2msghub_client_count:
    name: yolo2msghub_client_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_event_client_count_mean
      - sensor.yolo2msghub_event_client_count_max_value
      - sensor.yolo2msghub_event_client_count_min_value
  yolo2msghub_client_stdev:
    name: yolo2msghub_client_stdev
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_event_client_count_stdev_mean
      - sensor.yolo2msghub_event_client_count_standard_deviation
  # product ratio
  yolo2msghub_product_ratio:
    name: yolo2msghub_product_ratio
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.yolo2msghub_product_ratio_cloudvm
      - sensor.yolo2msghub_product_ratio_nano
      - sensor.yolo2msghub_product_ratio_rpi3bp
      - sensor.yolo2msghub_product_ratio_rpi3b
      - sensor.yolo2msghub_product_ratio_tx2
      - sensor.yolo2msghub_product_ratio_virtualbox
      - sensor.yolo2msghub_product_ratio_other
  ## SDR
  # count
  sdr2msghub_events_count:
    name: sdr2msghub_events_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.sdr2msghub_events_count
  # ago
  sdr2msghub_event_ago:
    name: sdr2msghub_event_ago
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.sdr2msghub_event_ago_mean
      - sensor.sdr2msghub_event_ago_min_value
      - sensor.sdr2msghub_event_ago_max_value
  # sentiment
  sdr2msghub_sentiment:
    name: sdr2msghub_sentiment
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.sdr2msghub_sentiment_score
      - sensor.sdr2msghub_sentiment_mean
  ## CPU
  cpu2msghub_cpu:
    name: cpu2msghub_cpu
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.cpu2msghub_cpu
      - sensor.cpu2msghub_cpu_mean
  cpu2msghub_count:
    name: cpu2msghub_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.cpu2msghub_count
  ## INTRANET
  intranet_docsisgw_test:
    name: Intranet DOCSISGW Test
    hours_to_show: 2
    refresh: 30
    entities:
      # - sensor.intranet_docsisgw_test_receive
      - sensor.intranet_docsisgw_receive_mean
      - sensor.intranet_docsisgw_receive_min_value
      - sensor.intranet_docsisgw_receive_max_value
      # - sensor.intranet_docsisgw_test_send
      - sensor.intranet_docsisgw_send_mean
      - sensor.intranet_docsisgw_send_min_value
      - sensor.intranet_docsisgw_send_max_value
  ## INTRANET
  intranet_dslgw_test:
    name: Intranet DSLGW Test
    hours_to_show: 2
    refresh: 30
    entities:
      # - sensor.intranet_dslgw_test_receive
      - sensor.intranet_dslgw_receive_mean
      - sensor.intranet_dslgw_receive_min_value
      - sensor.intranet_dslgw_receive_max_value
      # - sensor.intranet_dslgw_test_send
      - sensor.intranet_dslgw_send_mean
      - sensor.intranet_dslgw_send_min_value
      - sensor.intranet_dslgw_send_max_value
  ## INTERNET
  internet_receive:
    name: Internet Receive
    hours_to_show: 2
    refresh: 30
    entities:
      # - sensor.internet_test_receive
      - sensor.internet_receive_mean
      - sensor.internet_receive_min_value
      - sensor.internet_receive_max_value
  internet_send_stdev:
    name: Internet Send Stdev
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.internet_send_stdev_mean
      - sensor.internet_send_standard_deviation
  internet_recv_stdev:
    name: Internet Recv Stdev
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.internet_receive_stdev_mean
      - sensor.internet_receive_standard_deviation
  internet_send:
    name: Internet Send
    hours_to_show: 2
    refresh: 30
    entities:
      # - sensor.internet_test_send
      - sensor.internet_send_mean
      - sensor.internet_send_min_value
      - sensor.internet_send_max_value
  internet_tests:
    name: Internet Tests
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.internet_slow_count
      - sensor.internet_fast_count
      - sensor.internet_tests_count
  ##
  ## MOTION
  ##
  # image event
  motion_event_images_count:
    name: motion_event_images_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.motion_event_images_count
  motion_event_image_ago:
    name: motion_event_image_ago
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.motion_event_image_ago_mean
      - sensor.motion_event_image_ago_min_value
      - sensor.motion_event_image_ago_max_value
  # end event
  motion_events_count:
    name: motion_events_count
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.motion_events_count
  motion_event_ago:
    name: motion_event_ago
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.motion_event_ago_mean
      - sensor.motion_event_ago_min_value
      - sensor.motion_event_ago_max_value
  motion_event_elapsed:
    name: motion_event_elapsed
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.motion_event_elapsed_mean
      - sensor.motion_event_elapsed_min_value
      - sensor.motion_event_elapsed_max_value
  ##
  ## HORIZON
  ##
  horizon_exchange_status:
    name: horizon_exchange_status
    hours_to_show: 2
    refresh: 30
    entities:
      - sensor.horizon_exchange_status_nodes
      - sensor.horizon_exchange_status_users
      - sensor.horizon_exchange_status_node_agreements
      - sensor.horizon_exchange_status_agbot_agreements

###
### STARTUP
###

sensor startup:
  - platform: mqtt
    qos: 1
    name: startup_event
    state_topic: 'startup'
    force_update: true
    expire_after: 1
    json_attributes:
      - startup
    value_template: >
      {%- if value_json is defined -%}true{%- else -%}false{%- endif -%}
  - platform: template
    sensors:
      ## counting
      startup_events_count:
        entity_id:
          - counter.startup_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.startup_event_counter is defined %}
            {{ states.counter.startup_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      startup_event_ago:
        entity_id:
          - sensor.startup_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.startup_event.attributes.startup.date|int) }}
          {%- else -%}null{%- endif -%}
      # mean ago
      startup_event_ago_mean:
        entity_id:
          - sensor.startup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event_ago_statistics_mean is defined %}
            {{ states.sensor.startup_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_event_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.startup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event_ago_statistics_mean is defined %}
            {{ states.sensor.startup_event_ago_statistics_mean.attributes.min_value|float }}
          {%- else -%}null{%- endif -%}
      startup_event_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.startup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event_ago_statistics_mean is defined %}
            {{ states.sensor.startup_event_ago_statistics_mean.attributes.max_value|float }}
          {%- else -%}null{%- endif -%}
      ## status 
      startup_event_status:
        entity_id:
          - sensor.startup_event
        value_template: >-
          {% if states.sensor.startup_event.attributes.startup.date is defined %}
            From {{ states.sensor.startup_latest_id.state }}
          {% else %} null {% endif %}
  # count
  - platform: statistics
    name: startup_event_count_statistics
    entity_id: sensor.startup_events_count
    sampling_size: 100
    max_age:
      hours: 2
  # ago
  - platform: statistics
    name: startup_event_ago_statistics
    entity_id: sensor.startup_event_ago
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      ## location
      startup_latitude:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: latitude
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).latitude|float }}
          {%- else -%}null{%- endif -%}
      startup_longitude:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: longitude
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).longitude|float }}
          {%- else -%}null{%- endif -%}
      ## calculators
      startup_client_count:
        entity_id:
          - sensor.startup_event
          - sensor.startup_event
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ states.sensor.startup_event.attributes.startup.activity|length }}
          {%- else -%}null{%- endif -%}
      startup_client_percent:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: '%'
        value_template: >-
          {% if states.sensor.startup_client_count is defined and states.sensor.horizon_organization_nodes_count is defined and states.sensor.horizon_organization_nodes_count.state != null and states.sensor.horizon_organization_nodes_count is defined and states.sensor.horizon_organization_nodes_count.state|int > 0 %}
            {{ '%0.2f' | format(states.sensor.startup_client_count.state|float / states.sensor.horizon_organization_nodes_count.state|float * 100.0 ) }}
          {% else %} null {% endif %}
      startup_event_date:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event is defined and states.sensor.startup_event.attributes.startup.date is defined %}
            {{ states.sensor.startup_event.attributes.startup.date }}
          {% else %} null {% endif %}
      startup_event_timestamp:
        entity_id:
          - sensor.startup_event
        value_template: >-
          {% if states.sensor.startup_event is defined and states.sensor.startup_event.attributes.startup is defined %}
            {{ states.sensor.startup_event.attributes.startup.timestamp }}
          {% else %} null {% endif %}
      startup_event_period:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event is defined and states.sensor.startup_event.attributes.startup.period is defined %}
            {{ states.sensor.startup_event.attributes.startup.period }}
          {% else %} null {% endif %}
      ## latest activity details
      startup_latest_id:
        entity_id:
          - sensor.startup_event
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).id }}
          {%- else -%}null{%- endif -%}
      startup_latest_date:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).date }}
          {%- else -%}null{%- endif -%}
      startup_latest_measurement:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: events
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).count }}
          {%- else -%}null{%- endif -%}
      startup_latest_interval:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).interval }}
          {%- else -%}null{%- endif -%}
      startup_latest_timestamp:
        entity_id:
          - sensor.startup_event
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).timestamp }}
          {%- else -%}null{%- endif -%}
      startup_latest_ago:
        entity_id:
          - sensor.startup_event
          - sun.sun
        unit_of_measurement: seconds
        # {{ (now().timestamp()|int) - ((states.sensor.startup_event.attributes.startup.activity|first).date|int) }}
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ now().timestamp()|int - as_timestamp(strptime((states.sensor.startup_event.attributes.startup.activity|first).timestamp, "%FT%TZ"))|int }}
          {%- else -%}null{%- endif -%}
      startup_latest_average:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: containers
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).average }}
          {%- else -%}null{%- endif -%}
      ## download speed from wan
      startup_latest_download:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.startup_event is defined 
             and states.sensor.startup_event.attributes is defined
             and states.sensor.startup_event.attributes != null
             and states.sensor.startup_event.attributes.startup is defined
             and states.sensor.startup_event.attributes.startup.activity is defined
             and states.sensor.startup_event.attributes.startup.activity != null %}
             {% set result = (states.sensor.startup_event.attributes.startup.activity|first).download %}
             {% if result != null %}
                {{ '%0.2f' | format(result|float / 1000000.0) }}
             {% else %}
                {{ '%0.2f' | format(0.0 / 1000000.0) }}
             {% endif %}
          {%- else -%}null{%- endif -%}
      ## download percent from cpu
      startup_latest_percent:
        entity_id:
          - sensor.startup_event
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ '%0.2f' | format((states.sensor.startup_event.attributes.startup.activity|first).percent) }}
          {%- else -%}null{%- endif -%}
      ## product from hal
      startup_latest_product:
        entity_id:
          - sensor.startup_event
        value_template: >
          {% if states.sensor.startup_event.attributes.startup.activity is defined %}
            {{ (states.sensor.startup_event.attributes.startup.activity|first).product }}
          {%- else -%}null{%- endif -%}
      startup_latest_product_type:
        entity_id:
          - sensor.startup_latest_product
        unit_of_measurement: product_type
        value_template: >
          {% if states.sensor.startup_latest_product is defined %}
            {% if "Raspberry Pi 3 Model B Plus" in states.sensor.startup_latest_product.state %}
              {{ 'raspberrypi-3bp' }}
            {% elif "Raspberry Pi 3 Model B" in states.sensor.startup_latest_product.state %}
              {{ 'raspberrypi-3b' }}
            {% elif "jetson-nano" in states.sensor.startup_latest_product.state %}
              {{ 'jetson-nano' }}
            {% elif "quill" in states.sensor.startup_latest_product.state %}
              {{ 'jetson-tx2' }}
            {% elif "VirtualBox" in states.sensor.startup_latest_product.state %}
              {{ 'virtualbox' }}
            {% elif "HVM" in states.sensor.startup_latest_product.state %}
              {{ 'cloudvm' }}
            {% else %}
              {{ 'other' }}
            {% endif %}
          {%- else -%}null{%- endif -%}
      ## client count
      startup_client_count_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.startup_client_count_statistics_mean is defined %}
            {{ states.sensor.startup_client_count_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_client_count_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.startup_client_count_statistics_mean is defined %}
            {{ states.sensor.startup_client_count_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      startup_client_count_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.startup_client_count_statistics_mean is defined %}
            {{ states.sensor.startup_client_count_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      startup_client_count_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.startup_client_count_statistics_mean is defined %}
            {% if states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## client percent
      startup_client_percent_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_client_percent_statistics_mean is defined %}
            {{ states.sensor.startup_client_percent_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_client_percent_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_client_percent_statistics_mean is defined %}
            {{ states.sensor.startup_client_percent_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      startup_client_percent_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_client_percent_statistics_mean is defined %}
            {{ states.sensor.startup_client_percent_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      startup_client_percent_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_client_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_client_percent_statistics_mean is defined %}
            {% if states.sensor.startup_client_percent_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_client_percent_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## containers average
      startup_container_average_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_container_average_statistics_mean
        unit_of_measurement: containers
        value_template: >
          {% if states.sensor.startup_container_average_statistics_mean is defined %}
            {{ states.sensor.startup_container_average_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_container_average_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_container_average_statistics_mean
        unit_of_measurement: containers
        value_template: >
          {% if states.sensor.startup_container_average_statistics_mean is defined %}
            {{ states.sensor.startup_container_average_statistics_mean.attributes.min_value|float }}
          {%- else -%}null{%- endif -%}
      startup_container_average_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_container_average_statistics_mean
        unit_of_measurement: containers
        value_template: >
          {% if states.sensor.startup_container_average_statistics_mean is defined %}
            {{ states.sensor.startup_container_average_statistics_mean.attributes.max_value|float }}
          {%- else -%}null{%- endif -%}
      startup_container_average_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_container_average_statistics_mean
        unit_of_measurement: containers
        value_template: >
          {% if states.sensor.startup_container_average_statistics_mean is defined %}
            {% if states.sensor.startup_container_average_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_container_average_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## downloads average
      startup_download_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_download_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.startup_download_statistics_mean is defined %}
            {{ states.sensor.startup_download_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_download_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_download_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.startup_download_statistics_mean is defined %}
            {{ states.sensor.startup_download_statistics_mean.attributes.min_value|float }}
          {%- else -%}null{%- endif -%}
      startup_download_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_download_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.startup_download_statistics_mean is defined %}
            {{ states.sensor.startup_download_statistics_mean.attributes.max_value|float }}
          {%- else -%}null{%- endif -%}
      startup_download_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_download_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.startup_download_statistics_mean is defined %}
            {% if states.sensor.startup_download_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_download_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## measurements average
      startup_measurement_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_measurement_statistics_mean
        unit_of_measurement: events
        value_template: >
          {% if states.sensor.startup_measurement_statistics_mean is defined %}
            {{ states.sensor.startup_measurement_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_measurement_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_measurement_statistics_mean
        unit_of_measurement: events
        value_template: >
          {% if states.sensor.startup_measurement_statistics_mean is defined %}
            {{ states.sensor.startup_measurement_statistics_mean.attributes.min_value|float }}
          {%- else -%}null{%- endif -%}
      startup_measurement_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_measurement_statistics_mean
        unit_of_measurement: events
        value_template: >
          {% if states.sensor.startup_measurement_statistics_mean is defined %}
            {{ states.sensor.startup_measurement_statistics_mean.attributes.max_value|float }}
          {%- else -%}null{%- endif -%}
      startup_measurement_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_measurement_statistics_mean
        unit_of_measurement: events
        value_template: >
          {% if states.sensor.startup_measurement_statistics_mean is defined %}
            {% if states.sensor.startup_measurement_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_measurement_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## percent average
      startup_percent_mean:
        entity_id:
          - sensor.startup_event
          - sensor.startup_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_percent_statistics_mean is defined %}
            {{ states.sensor.startup_percent_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      startup_percent_min_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_percent_statistics_mean is defined %}
            {{ states.sensor.startup_percent_statistics_mean.attributes.min_value|float }}
          {%- else -%}null{%- endif -%}
      startup_percent_max_value:
        entity_id:
          - sensor.startup_event
          - sensor.startup_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_percent_statistics_mean is defined %}
            {{ states.sensor.startup_percent_statistics_mean.attributes.max_value|float }}
          {%- else -%}null{%- endif -%}
      startup_percent_standard_deviation:
        entity_id:
          - sensor.startup_event
          - sensor.startup_percent_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.startup_percent_statistics_mean is defined %}
            {% if states.sensor.startup_percent_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.startup_percent_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
  # client count
  - platform: statistics
    entity_id: sensor.startup_client_count_standard_deviation
    name: startup_client_count_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.startup_client_count
    name: startup_client_count_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client percent
  - platform: statistics
    entity_id: sensor.startup_client_percent_standard_deviation
    name: startup_client_percent_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.startup_client_percent
    name: startup_client_percent_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client download
  - platform: statistics
    entity_id: sensor.startup_latest_download
    name: startup_download_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client measurement
  - platform: statistics
    entity_id: sensor.startup_latest_measurement
    name: startup_measurement_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client percent
  - platform: statistics
    entity_id: sensor.startup_latest_percent
    name: startup_percent_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client containers (average)
  - platform: statistics
    entity_id: sensor.startup_latest_average
    name: startup_container_average_statistics
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.startup_container_average_standard_deviation
    name: startup_container_average_stdev
    sampling_size: 100
    max_age:
      hours: 2
  # ratio of machines whose container count is average
  - platform: history_stats
    name: startup_containers_average
    entity_id: binary_sensor.startup_containers_average
    state: on
    type: ratio 
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  ## history of HAL product type
  - platform: history_stats
    name: startup_product_ratio_rpi3bp
    entity_id: sensor.startup_latest_product_type
    state: 'raspberrypi-3bp'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_rpi3b
    entity_id: sensor.startup_latest_product_type
    state: 'raspberrypi-3b'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_nano
    entity_id: sensor.startup_latest_product_type
    state: 'jetson-nano'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_tx2
    entity_id: sensor.startup_latest_product_type
    state: 'jetson-tx2'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_virtualbox
    entity_id: sensor.startup_latest_product_type
    state: 'virtualbox'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_cloudvm
    entity_id: sensor.startup_latest_product_type
    state: 'cloudvm'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: startup_product_ratio_other
    entity_id: sensor.startup_latest_product_type
    state: 'other'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

binary_sensor startup:
  - platform: template
    sensors:
      ## state
      startup_event_state:
        entity_id:
          - sensor.startup_event_latest_id
          - sensor.startup_event_ago
        value_template: >
          {{ states.sensor.startup_event.state }}
      startup_containers_average:
        entity_id:
          - sensor.startup_latest_average
          - sensor.startup_container_average_statistics_mean
        value_template: >
          {% if states.sensor.startup_latest_average is defined and states.sensor.startup_container_average_statistics_mean is defined %}
            {{ (states.sensor.startup_latest_average.state|float) == (states.sensor.startup_container_average_statistics_mean.state|float) }}
          {%- else -%}false{%- endif -%}
      startup_client_low:
        entity_id:
          - sensor.startup_client_count
          - sensor.startup_client_count_statistics_mean
          - input_number.startup_client_deviation
        value_template: >-
          {% if states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.startup_client_count_statistics_mean.state|float) - (states.sensor.startup_client_count.state|float))
                 / (states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation|float) 
               > (states.input_number.startup_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      startup_client_low_persistent:
        entity_id:
          - sensor.startup_client_count
          - sensor.startup_client_count_stdev_mean
          - input_number.startup_client_deviation
        value_template: >-
          {% if states.sensor.startup_client_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.startup_client_count_statistics_mean.state|float) - (states.sensor.startup_client_count.state|float))
                 / (states.sensor.startup_client_count_stdev_mean.state|float) 
               > (states.input_number.startup_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      startup_client_high:
        entity_id:
          - sensor.startup_client_count
          - sensor.startup_client_count_statistics_mean
          - input_number.startup_client_deviation
        value_template: >-
          {% if states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.startup_client_count.state|float) - (states.sensor.startup_client_count_statistics_mean.state|float))
                 / (states.sensor.startup_client_count_statistics_mean.attributes.standard_deviation|float)) 
               > (states.input_number.startup_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      startup_client_high_persistent:
        entity_id:
          - sensor.startup_client_count
          - sensor.startup_client_count_stdev_mean
          - input_number.startup_client_deviation
        value_template: >-
          {% if states.input_number.startup_client_deviation.state|float > 0 %}
            {{ (((states.sensor.startup_client_count.state|float) - (states.sensor.startup_client_count_statistics_mean.state|float))
                 / (states.sensor.startup_client_count_stdev_mean.state|float)) 
               > (states.input_number.startup_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy

###
### YOLO2MSGHUB
###

sensor yolo2msghub:
  - platform: mqtt
    name: yolo2msghub_event
    state_topic: 'yolo2msghub'
    force_update: true
    expire_after: 1
    json_attributes:
      - yolo2msghub
    value_template: >
      {%- if value_json is defined -%}true{%- else -%}false{%- endif -%}
  - platform: template
    sensors:
      ## counting
      yolo2msghub_events_count:
        entity_id:
          - counter.yolo2msghub_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.yolo2msghub_event_counter is defined %}
            {{ states.counter.yolo2msghub_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      yolo2msghub_event_ago:
        entity_id:
          - sensor.yolo2msghub_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes.yolo2msghub.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.yolo2msghub_event.attributes.yolo2msghub.date|int) }}
          {%- else -%}null{%- endif -%}
      ## mean ago
      yolo2msghub_event_ago_mean:
        entity_id:
          - sensor.yolo2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_event_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_event_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## status
      yolo2msghub_event_status:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >-
          {% if states.sensor.yolo2msghub_event is defined and states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity is defined %}
            From {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).id }}
          {% else %} null {% endif %}
  ## statistics
  - platform: history_stats
    name: yolo2msghub_event_count
    entity_id: sensor.yolo2msghub_event
    state: true
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: yolo2msghub_event_count_statistics
    entity_id: sensor.yolo2msghub_events_count
    max_age:
      hours: 2
  - platform: statistics
    name: yolo2msghub_event_ago_statistics
    entity_id: sensor.yolo2msghub_event_ago
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      yolo2msghub_event_date:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event is defined and states.sensor.yolo2msghub_event.attributes.yolo2msghub.date is defined %}
            {{ states.sensor.yolo2msghub_event.attributes.yolo2msghub.date|int }}
          {% else %} null {% endif %}
      yolo2msghub_event_timestamp:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >-
          {% if states.sensor.yolo2msghub_event is defined and states.sensor.yolo2msghub_event.attributes.yolo2msghub.timestamp is defined %}
            {{ states.sensor.yolo2msghub_event.attributes.yolo2msghub.timestamp }}
          {% else %} null {% endif %}
      ## calculators
      yolo2msghub_event_client_count:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity is defined %}
            {{ states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|length }}
          {%- else -%}null{%- endif -%}
      ## latest activity details
      yolo2msghub_latest_id:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).id }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_entity:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).entity }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_date:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).date }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_timestamp:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).date | int | timestamp_custom("%a %b %d %I:%M %p") }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_count:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).count }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_first:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).first }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_last:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).last }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_interval:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).interval }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_ago:
        entity_id:
          - sensor.yolo2msghub_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity is defined %}
            {% if (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).ago is defined %}
              {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).ago }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_average:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: people
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).average }}
          {%- else -%}null{%- endif -%}
      ## download speed from wan
      yolo2msghub_latest_download:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined and states.sensor.yolo2msghub_event.attributes.activity is defined and states.sensor.yolo2msghub_event.attributes.activity != null %}
            {{ '%0.2f' | format( (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).download|float / 1000000.0) }}
          {%- else -%}null{%- endif -%}
      ## download speed from cpu
      yolo2msghub_latest_percent:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ '%0.2f' | format((states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).percent) }}
          {%- else -%}null{%- endif -%}
      ## product from hal
      yolo2msghub_latest_product:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).product }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_product_type:
        entity_id:
          - sensor.yolo2msghub_latest_product
        value_template: >
          {% if states.sensor.yolo2msghub_latest_product is defined %}
            {% if "Raspberry Pi 3 Model B Plus" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'raspberrypi-3bp' }}
            {% elif "Raspberry Pi 3 Model B" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'raspberrypi-3b' }}
            {% elif "jetson-nano" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'jetson-nano' }}
            {% elif "quill" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'jetson-tx2' }}
            {% elif "VirtualBox" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'virtualbox' }}
            {% elif "HVM" in states.sensor.yolo2msghub_latest_product.state %}
              {{ 'cloudvm' }}
            {% else %}
              {{ 'other' }}
            {% endif %}
          {%- else -%}null{%- endif -%}
      ## items from yolo
      yolo2msghub_latest_mock:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).mock }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_latest_seen:
        entity_id:
          - sensor.yolo2msghub_event
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_event.attributes is defined %}
            {{ (states.sensor.yolo2msghub_event.attributes.yolo2msghub.activity|first).seen }}
          {%- else -%}0{%- endif -%}
      ## any activity count
      yolo2msghub_event_client_count_mean:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_client_count_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_event_client_count_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_event_client_count_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_event_client_count_standard_deviation:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_event_client_count_statistics_mean
        unit_of_measurement: clients
        value_template: >
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean is defined %}
            {% if states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      ## entity detected
      yolo2msghub_entity_detected_mean:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_entity_detected_statistics_mean
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_entity_detected_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_entity_detected_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_entity_detected_total:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_entity_detected_statistics_mean
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_entity_detected is defined %}
            {{ states.sensor.yolo2msghub_entity_detected.state|int }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_entity_detected_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_entity_detected_statistics_mean
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_entity_detected_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_entity_detected_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_entity_detected_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_entity_detected_statistics_mean
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_entity_detected_statistics_mean is defined %}
            {{ states.sensor.yolo2msghub_entity_detected_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      yolo2msghub_entity_detected_standard_deviation:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.yolo2msghub_entity_detected_statistics_mean
        unit_of_measurement: entities
        value_template: >
          {% if states.sensor.yolo2msghub_entity_detected_statistics_mean is defined %}
            {% if states.sensor.yolo2msghub_entity_detected_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.yolo2msghub_entity_detected_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
  # client count
  - platform: statistics
    entity_id: sensor.yolo2msghub_event_client_count_standard_deviation
    name: yolo2msghub_event_client_count_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.yolo2msghub_event_client_count
    name: yolo2msghub_event_client_count_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client download
  - platform: statistics
    entity_id: sensor.yolo2msghub_latest_download
    name: yolo2msghub_entity_download_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client seen
  - platform: statistics
    entity_id: sensor.yolo2msghub_latest_seen
    name: yolo2msghub_entity_detected_statistics
    sampling_size: 100
    max_age:
      hours: 2
  # client detected
  - platform: statistics
    entity_id: sensor.yolo2msghub_entity_detected_standard_deviation
    name: yolo2msghub_entity_detected_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: history_stats
    name: yolo2msghub_entity_detected
    entity_id: binary_sensor.yolo2msghub_entity_detected
    state: on
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  ## history of HAL product type
  - platform: history_stats
    name: yolo2msghub_product_ratio_rpi3bp
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'raspberrypi-3bp'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_rpi3b
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'raspberrypi-3b'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_nano
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'jetson-nano'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_tx2
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'jetson-tx2'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_virtualbox
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'virtualbox'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_cloudvm
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'cloudvm'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: yolo2msghub_product_ratio_other
    entity_id: sensor.yolo2msghub_latest_product_type
    state: 'other'
    type: ratio
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

binary_sensor yolo2msghub_event:
  - platform: template
    sensors:
      ## state
      yolo2msghub_event_state:
        entity_id:
          - sensor.yolo2msghub_event_latest_id
          - sensor.yolo2msghub_event_ago
        value_template: >
          {{ states.sensor.yolo2msghub_event.state }}
      yolo2msghub_entity_detected:
        entity_id:
          - sensor.yolo2msghub_event
        value_template: >
          {% if states.sensor.yolo2msghub_latest_seen is defined %}
            {{ states.sensor.yolo2msghub_latest_seen.state|int > 0 }}
          {%- else -%}false{%- endif -%}
      yolo2msghub_client_low:
        entity_id:
          - sensor.yolo2msghub_event_client_count
          - sensor.yolo2msghub_event_client_count_statistics_mean
          - input_number.yolo2msghub_client_deviation
        value_template: >-
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.yolo2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.yolo2msghub_event_client_count.state|float))
                 / (states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float) 
               > (states.input_number.yolo2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      yolo2msghub_client_low_persistent:
        entity_id:
          - sensor.yolo2msghub_event_client_count
          - sensor.yolo2msghub_event_client_count_stdev_mean
          - input_number.yolo2msghub_client_deviation
        value_template: >-
          {% if states.sensor.yolo2msghub_event_client_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.yolo2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.yolo2msghub_event_client_count.state|float))
                 / (states.sensor.yolo2msghub_event_client_count_stdev_mean.state|float) 
               > (states.input_number.yolo2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      yolo2msghub_client_high:
        entity_id:
          - sensor.yolo2msghub_event_client_count
          - sensor.yolo2msghub_event_client_count_statistics_mean
          - input_number.yolo2msghub_client_deviation
        value_template: >-
          {% if states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.yolo2msghub_event_client_count.state|float) - (states.sensor.yolo2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.yolo2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float)) 
               > (states.input_number.yolo2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      yolo2msghub_client_high_persistent:
        entity_id:
          - sensor.yolo2msghub_event_client_count
          - sensor.yolo2msghub_event_client_count_stdev_mean
          - input_number.yolo2msghub_client_deviation
        value_template: >-
          {% if states.input_number.yolo2msghub_client_deviation.state|float > 0 %}
            {{ (((states.sensor.yolo2msghub_event_client_count.state|float) - (states.sensor.yolo2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.yolo2msghub_event_client_count_stdev_mean.state|float)) 
               > (states.input_number.yolo2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
 
camera yolo2msghub:
  - platform: mqtt
    name: yolo2msghub
    topic: 'yolo2msghub/image'

###
### SDR2MSGHUB
###

sensor sdr2msghub:
  - platform: mqtt
    name: sdr2msghub_event
    state_topic: 'kafka/sdr-audio'
    force_update: true
    expire_after: 1
    json_attributes:
      - name
      - date
      - latitude
      - longitude
      - frequency
      - value 
      - bytes
      - stt
    value_template: >
      {% if value_json is defined and value_json.bytes > 0 %} true {% else %} false {% endif %}
  ## standard event count, ago, mean, status
  - platform: template
    sensors:
      ## counting
      sdr2msghub_events_count:
        entity_id:
          - counter.sdr2msghub_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.sdr2msghub_event_counter is defined %}
            {{ states.counter.sdr2msghub_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      sdr2msghub_event_ago:
        entity_id:
          - sensor.sdr2msghub_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.sdr2msghub_event.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      ## statistics
      sdr2msghub_event_ago_mean:
        entity_id:
          - sensor.sdr2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.sdr2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.sdr2msghub_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_event_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.sdr2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.sdr2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.sdr2msghub_event_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_event_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.sdr2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.sdr2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.sdr2msghub_event_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## derived
      sdr2msghub_event_status:
        entity_id:
          - sensor.sdr2msghub_event
        value_template: >-
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.name is defined %}
            From {{ states.sensor.sdr2msghub_event.attributes.name }}
          {% else %} null {% endif %}
  - platform: history_stats
    name: sdr2msghub_event_count
    entity_id: sensor.sdr2msghub_event
    state: true
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    entity_id: sensor.sdr2msghub_event_ago
    name: sdr2msghub_event_ago_statistics
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      # location
      sdr2msghub_latitude:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: degrees
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.latitude is defined %}
            {{ states.sensor.sdr2msghub_event.attributes.latitude }}
          {% else %} null {% endif %}
      sdr2msghub_longitude:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: degrees
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.longitude is defined %}
            {{ states.sensor.sdr2msghub_event.attributes.longitude }}
          {% else %} null {% endif %}
      # date
      sdr2msghub_date:
        entity_id:
          - sensor.sdr2msghub_event
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.date is defined %}
            {{ states.sensor.sdr2msghub_event.attributes.date | int | timestamp_custom("%a %b %d %I:%M %p") }}
          {% else %} null {% endif %}
      sdr2msghub_name:
        entity_id:
          - sensor.sdr2msghub_event
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.name is defined %}
            {{ states.sensor.sdr2msghub_event.attributes.name }}
          {% else %} null {% endif %}
      sdr2msghub_frequency:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: MHz
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.frequency is defined and states.sensor.sdr2msghub_event.attributes.frequency.state != null %}
            {{ states.sensor.sdr2msghub_event.attributes.frequency|float / 1000000.0 }}
          {% else %} null {% endif %}
      sdr2msghub_bytes:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: bytes
        value_template: >
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.bytes is defined %}
            {{ states.sensor.sdr2msghub_event.attributes.bytes }}
          {% else %} null {% endif %}
      sdr2msghub_results:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: RC
        value_template: >-
          {%- if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.results is defined -%}
            {{- states.sensor.sdr2msghub_event.attributes.stt.results|length -}}
          {%- else -%} null {%- endif -%}
      sdr2msghub_sentiments:
        entity_id:
          - sensor.sdr2msghub_event
          - input_number.sdr2msghub_confidence
        value_template: >-
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.results is defined %}
            {% set results = states.sensor.sdr2msghub_event.attributes.stt.results %}
            {% for result in results %}
              {%- if loop.first -%}{%- else -%},{%- endif -%}
              {%- for alternative in result.alternatives -%}
                {%- if loop.first -%}{%- else -%},{%- endif -%}
                {%- if alternative.confidence|float > states.input_number.sdr2msghub_confidence|float -%}
                  {%- if alternative.nlu is defined and alternative.nlu.sentiment is defined -%}
                    {%- if alternative.nlu.sentiment.document.label is defined -%}
                      {{- alternative.nlu.sentiment.document.label -}}
                    {%- else -%}null{%- endif -%}
                  {%- else -%}null{%- endif -%}
                {%- else -%}null{%- endif -%}
              {%- endfor -%}
            {%- endfor %}
          {%- else -%} null {%- endif -%}
      sdr2msghub_languages:
        entity_id:
          - sensor.sdr2msghub_event
          - input_number.sdr2msghub_confidence
        value_template: >-
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.results is defined %}
            {% set results = states.sensor.sdr2msghub_event.attributes.stt.results %}
            {% for result in results %}
              {%- if loop.first -%}{%- else -%},{%- endif -%}
              {%- for alternative in result.alternatives -%}
                {%- if loop.first -%}{%- else -%},{%- endif -%}
                {%- if alternative.confidence > states.input_number.sdr2msghub_confidence|float -%}
                  {%- if alternative.nlu is defined and alternative.nlu.language is defined -%}
                    {{- alternative.nlu.language -}}
                  {%- else -%}null{%- endif -%}
                {%- else -%}null{%- endif -%}
              {%- endfor -%}
            {%- endfor %}
          {%- else -%} null {%- endif -%}
      sdr2msghub_confidence_minimum:
        entity_id:
          - input_number.sdr2msghub_confidence
        unit_of_measurement: CV
        value_template: >
          {{ states.input_number.sdr2msghub_confidence.state }}
      sdr2msghub_relevance_minimum:
        entity_id:
          - input_number.sdr2msghub_relevance
        unit_of_measurement: RV
        value_template: >
          {{ states.input_number.sdr2msghub_relevance.state }}
      sdr2msghub_all_keywords:
        entity_id:
          - sensor.sdr2msghub_event
          - sensor.sdr2msghub_confidence_minimum
          - sensor.sdr2msghub_relevance_minimum
        value_template: >-
          {% if states.sensor.sdr2msghub_event is defined and states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.results is defined %}
            {% set results = states.sensor.sdr2msghub_event.attributes.stt.results %}
            {% for result in results %}
              {%- if loop.first -%}{% else %},{% endif %}
              {%- for alternative in result.alternatives -%}
                {%- if loop.first -%}{% else %},{% endif %}
                {%- if alternative.confidence|float > states.sensor.sdr2msghub_confidence_minimum.state|float  -%}
                  {%- if alternative.nlu is defined and alternative.nlu.keywords is defined and alternative.nlu.keywords != null -%}
                    {%- for keyword in alternative.nlu.keywords -%}
                      {%- if loop.first -%}{% else %},{% endif %}
                      {%- if keyword.text is defined and keyword.relevance|float > states.sensor.sdr2msghub_relevance_minimum.state|float -%}
                        {{- keyword.text -}}
                      {%- else -%}null{%- endif -%}
                    {%- endfor -%}
                  {%- else -%}null{%- endif -%}
                {%- else -%}null{%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- else -%}null{%- endif -%}
      sdr2msghub_characters:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: characters
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu != null %}
            {% set nlu = states.sensor.sdr2msghub_event.attributes.stt.nlu %}
            {{ nlu.usage.text_characters|int }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_language:
        entity_id:
          - sensor.sdr2msghub_event
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu != null %}
            {% set nlu = states.sensor.sdr2msghub_event.attributes.stt.nlu %}
            {{ nlu.language }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_sentiment_score:
        entity_id:
          - sensor.sdr2msghub_event
        unit_of_measurement: SS
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu != null %}
            {% set nlu = states.sensor.sdr2msghub_event.attributes.stt.nlu %}
            {{ nlu.sentiment.document.score|float }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_sentiment_label:
        entity_id:
          - sensor.sdr2msghub_event
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu != null %}
            {% set nlu = states.sensor.sdr2msghub_event.attributes.stt.nlu %}
            {{ nlu.sentiment.document.label }}
          {%- else -%}null{%- endif -%}
      sdr2msghub_keywords:
        entity_id:
          - sensor.sdr2msghub_event
          - sensor.sdr2msghub_relevance_minimum
        value_template: >
          {% if states.sensor.sdr2msghub_event.attributes.stt is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu is defined and states.sensor.sdr2msghub_event.attributes.stt.nlu != null %}
            {% set nlu = states.sensor.sdr2msghub_event.attributes.stt.nlu %}
            {% for keyword in nlu.keywords %}
             {%- if loop.first -%}{% else %},{% endif %}
             {%- if keyword.text is defined and keyword.relevance|float > states.sensor.sdr2msghub_relevance_minimum.state|float -%}
               {{- keyword.text -}}
             {%- else -%}null{%- endif -%}
           {%- endfor -%}
          {%- else -%}null{%- endif -%}
      sdr2msghub_sentiment_mean:
        entity_id:
          - sensor.sdr2msghub_sentiment_statistics_mean
        unit_of_measurement: SS 
        value_template: >
          {% if states.sensor.sdr2msghub_event_sentiment_mean is defined %}
            {{ states.sensor.sdr2msghub_sentiment_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
  ## statistics on attributes
  - platform: statistics
    entity_id: sensor.sdr2msghub_sentiment_score
    name: sdr2msghub_sentiment_statistics
    max_age:
      hours: 2

binary_sensor sdr2msghub_event:
  - platform: template
    sensors:
      ## state
      sdr2msghub_event_state:
        entity_id:
          - sensor.sdr2msghub_event_latest_id
          - sensor.sdr2msghub_event_ago
        value_template: >
          {{ states.sensor.sdr2msghub_event.state }}
      sdr2msghub_client_low:
        entity_id:
          - sensor.sdr2msghub_event_client_count
          - sensor.sdr2msghub_event_client_count_statistics_mean
          - input_number.sdr2msghub_client_deviation
        value_template: >-
          {% if states.sensor.sdr2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.sdr2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.sdr2msghub_event_client_count.state|float))
                 / (states.sensor.sdr2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float)
               > (states.input_number.sdr2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      sdr2msghub_client_low_persistent:
        entity_id:
          - sensor.sdr2msghub_event_client_count
          - sensor.sdr2msghub_event_client_count_stdev_mean
          - input_number.sdr2msghub_client_deviation
        value_template: >-
          {% if states.sensor.sdr2msghub_event_client_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.sdr2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.sdr2msghub_event_client_count.state|float))
                 / (states.sensor.sdr2msghub_event_client_count_stdev_mean.state|float)
               > (states.input_number.sdr2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      sdr2msghub_client_high:
        entity_id:
          - sensor.sdr2msghub_event_client_count
          - sensor.sdr2msghub_event_client_count_statistics_mean
          - input_number.sdr2msghub_client_deviation
        value_template: >-
          {% if states.sensor.sdr2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.sdr2msghub_event_client_count.state|float) - (states.sensor.sdr2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.sdr2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float))
               > (states.input_number.sdr2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      sdr2msghub_client_high_persistent:
        entity_id:
          - sensor.sdr2msghub_event_client_count
          - sensor.sdr2msghub_event_client_count_stdev_mean
          - input_number.sdr2msghub_client_deviation
        value_template: >-
          {% if states.input_number.sdr2msghub_client_deviation.state|float > 0 %}
            {{ (((states.sensor.sdr2msghub_event_client_count.state|float) - (states.sensor.sdr2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.sdr2msghub_event_client_count_stdev_mean.state|float))
               > (states.input_number.sdr2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy

###
### CPU2MSGHUB
###
  
sensor cpu2msghub:
  - platform: mqtt
    name: cpu2msghub_event
    state_topic: 'cpu2msghub'
    force_update: true
    expire_after: 1
    json_attributes:
      - name
      - date
      - cpu
      - longitude
      - latitude
      - altitude
    value_template: >
      {% if value_json is defined %} true {% else %} false {% endif %}
  ## standard event count, ago, mean, status
  - platform: template
    sensors:
      ## counting
      cpu2msghub_events_count:
        entity_id:
          - counter.cpu2msghub_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.cpu2msghub_event_counter is defined %}
            {{ states.counter.cpu2msghub_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      cpu2msghub_event_ago:
        entity_id:
          - sensor.cpu2msghub_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.cpu2msghub_event.attributes.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.cpu2msghub_event.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      ## statistics
      cpu2msghub_event_ago_mean:
        entity_id:
          - sensor.cpu2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.cpu2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.cpu2msghub_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      cpu2msghub_event_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.cpu2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.cpu2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.cpu2msghub_event_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      cpu2msghub_event_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.cpu2msghub_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.cpu2msghub_event_ago_statistics_mean is defined %}
            {{ states.sensor.cpu2msghub_event_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## derived
      cpu2msghub_event_status:
        entity_id:
          - sensor.cpu2msghub_event
        value_template: >-
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.date is defined %}
            From {{ states.sensor.cpu2msghub_event.attributes.name }}
          {% else %} null {% endif %}
  - platform: history_stats
    name: cpu2msghub_event_count
    entity_id: sensor.cpu2msghub_event
    state: true
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    entity_id: sensor.cpu2msghub_event_ago
    name: cpu2msghub_event_ago_statistics
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      cpu2msghub_date:
        entity_id:
          - sensor.cpu2msghub_event
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.date is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.date | int | timestamp_custom("%a %b %d %I:%M %p") }}
          {% else %} null {% endif %}
      cpu2msghub_name:
        entity_id:
          - sensor.cpu2msghub_event
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.name is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.name}}
          {% else %} null {% endif %}
      cpu2msghub_cpu:
        entity_id:
          - sensor.cpu2msghub_event
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.cpu is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.cpu}}
          {% else %} null {% endif %}
      cpu2msghub_latitude:
        entity_id:
          - sensor.cpu2msghub_event
        unit_of_measurement: degrees
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.latitude is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.latitude}}
          {% else %} null {% endif %}
      cpu2msghub_longitude:
        entity_id:
          - sensor.cpu2msghub_event
        unit_of_measurement: degrees
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.longitude is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.longitude}}
          {% else %} null {% endif %}
      cpu2msghub_altitude:
        entity_id:
          - sensor.cpu2msghub_event
        unit_of_measurement: feet
        value_template: >
          {% if states.sensor.cpu2msghub_event is defined and states.sensor.cpu2msghub_event.attributes.altitude is defined %}
            {{ states.sensor.cpu2msghub_event.attributes.altitude}}
          {% else %} null {% endif %}
      cpu2msghub_cpu_mean:
        entity_id:
          - sensor.cpu2msghub_cpu_statistics_mean
        unit_of_measurement: '%'
        value_template: >
          {% if states.sensor.cpu2msghub_cpu is defined %}
            {{ states.sensor.cpu2msghub_cpu_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
  ## statistics on attributes
  - platform: statistics
    entity_id: sensor.cpu2msghub_cpu
    name: cpu2msghub_cpu_statistics
    sampling_size: 100 
    max_age:
      hours: 2

binary_sensor cpu2msghub_event:
  - platform: template
    sensors:
      ## state
      cpu2msghub_event_state:
        entity_id:
          - sensor.cpu2msghub_event_latest_id
          - sensor.cpu2msghub_event_ago
        value_template: >
          {{ states.sensor.cpu2msghub_event.state }}
      cpu2msghub_client_low:
        entity_id:
          - sensor.cpu2msghub_event_client_count
          - sensor.cpu2msghub_event_client_count_statistics_mean
          - input_number.cpu2msghub_client_deviation
        value_template: >-
          {% if states.sensor.cpu2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.cpu2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.cpu2msghub_event_client_count.state|float))
                 / (states.sensor.cpu2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float)
               > (states.input_number.cpu2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      cpu2msghub_client_low_persistent:
        entity_id:
          - sensor.cpu2msghub_event_client_count
          - sensor.cpu2msghub_event_client_count_stdev_mean
          - input_number.cpu2msghub_client_deviation
        value_template: >-
          {% if states.sensor.cpu2msghub_event_client_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.cpu2msghub_event_client_count_statistics_mean.state|float) - (states.sensor.cpu2msghub_event_client_count.state|float))
                 / (states.sensor.cpu2msghub_event_client_count_stdev_mean.state|float)
               > (states.input_number.cpu2msghub_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      cpu2msghub_client_high:
        entity_id:
          - sensor.cpu2msghub_event_client_count
          - sensor.cpu2msghub_event_client_count_statistics_mean
          - input_number.cpu2msghub_client_deviation
        value_template: >-
          {% if states.sensor.cpu2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.cpu2msghub_event_client_count.state|float) - (states.sensor.cpu2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.cpu2msghub_event_client_count_statistics_mean.attributes.standard_deviation|float))
               > (states.input_number.cpu2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      cpu2msghub_client_high_persistent:
        entity_id:
          - sensor.cpu2msghub_event_client_count
          - sensor.cpu2msghub_event_client_count_stdev_mean
          - input_number.cpu2msghub_client_deviation
        value_template: >-
          {% if states.input_number.cpu2msghub_client_deviation.state|float > 0 %}
            {{ (((states.sensor.cpu2msghub_event_client_count.state|float) - (states.sensor.cpu2msghub_event_client_count_statistics_mean.state|float))
                 / (states.sensor.cpu2msghub_event_client_count_stdev_mean.state|float))
               > (states.input_number.cpu2msghub_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      
###
### HORIZON (via hznmonitor)
###

sensor horizon:
  - platform: rest
    name: horizon_organization_service_list
    resource: !secret cgi-services
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - services
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.services|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      horizon_organization_services_count:
        entity_id:
          - sensor.horizon_organization_service_list
        unit_of_measurement: services
        value_template: >
          {%- if states.sensor.horizon_organization_service_list.attributes.services|length > 0 %}
           {{ states.sensor.horizon_organization_service_list.attributes.services|length }}
          {% else %}null{% endif %}
  - platform: rest
    name: horizon_organization_node_list
    resource: !secret cgi-nodes
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - nodes
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.nodes|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      horizon_organization_nodes_count:
        entity_id:
          - sensor.horizon_organization_node_list
        unit_of_measurement: clients
        value_template: >
          {%- if states.sensor.horizon_organization_node_list is defined 
            and states.sensor.horizon_organization_node_list.attributes is defined
            and states.sensor.horizon_organization_node_list.attributes.nodes is defined %}
              {{ states.sensor.horizon_organization_node_list.attributes.nodes|length }}
          {% else %}null{% endif %}
  - platform: rest
    name: horizon_organization_pattern_list
    resource: !secret cgi-patterns
    method: GET
    authentication: basic
    force_update: true
    json_attributes:
      - patterns
      - exchange
      - org
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.patterns|length }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      horizon_organization_patterns_exchange:
        entity_id:
          - sensor.horizon_organization_pattern_list
        value_template: >
          {%- if states.sensor.horizon_organization_pattern_list.attributes.exchange is defined %}
           {{ states.sensor.horizon_organization_pattern_list.attributes.exchange }}
          {% else %}null{% endif %}
      horizon_organization_patterns_org:
        entity_id:
          - sensor.horizon_organization_pattern_list
        value_template: >
          {%- if states.sensor.horizon_organization_pattern_list.attributes.org is defined %}
           {{ states.sensor.horizon_organization_pattern_list.attributes.org }}
          {% else %}null{% endif %}
      horizon_organization_patterns_count:
        entity_id:
          - sensor.horizon_organization_pattern_list
        unit_of_measurement: patterns
        value_template: >
          {%- if states.sensor.horizon_organization_pattern_list.attributes.patterns|length > 0 %}
           {{ states.sensor.horizon_organization_pattern_list.attributes.patterns|length }}
          {% else %}null{% endif %}
      horizon_organization_patterns_id:
        entity_id:
          - sensor.horizon_organization_pattern_list
        value_template: >
          {%- if states.sensor.horizon_organization_pattern_list.attributes.patterns|length > 0 %}
            {%- for pattern in states.sensor.horizon_organization_pattern_list.attributes.patterns -%}
              {% if loop.first %}[{% else %},{% endif %}
              {{- pattern.id|replace(states.sensor.horizon_organization_patterns_org.state+"/","")|tojson -}}
              {%- if loop.last -%}]{%- endif -%}
            {% endfor %}
          {% else %}null{% endif %}
  - platform: rest
    name: horizon_exchange_status
    resource: !secret cgi-exchange
    method: GET
    authentication: basic
    username: !secret exchange_auth
    password: !secret exchange_api
    force_update: true
    json_attributes:
      - msg
      - org
      - url
      - dbSchemaVersion
      - numberOfAgbotAgreements
      - numberOfAgbotMsgs
      - numberOfAgbots
      - numberOfNodeAgreements
      - numberOfNodeMsgs
      - numberOfNodes
      - numberOfUsers
    value_template: >
      {%- if value_json is defined -%} {{ value_json.msg }} {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      horizon_exchange_org:
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.org }}
          {% else %}null{% endif %}
      horizon_exchange_url:
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.url }}
          {% else %}null{% endif %}
      horizon_exchange_msg:
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.msg }}
          {% else %}null{% endif %}
      horizon_exchange_status_agbot_agreements:
        unit_of_measurement: agreements
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.numberOfAgbotAgreements|int }}
          {% else %}null{% endif %}
      horizon_exchange_status_node_agreements:
        unit_of_measurement: agreements
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.numberOfNodeAgreements|int }}
          {% else %}null{% endif %}
      horizon_exchange_status_nodes:
        unit_of_measurement: nodes
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.numberOfNodes|int }}
          {% else %}null{% endif %}
      horizon_exchange_status_users:
        unit_of_measurement: users
        entity_id:
          - sensor.horizon_exchange_status
        value_template: >
          {% if states.sensor.horizon_exchange_status is defined %}
            {{ states.sensor.horizon_exchange_status.attributes.numberOfUsers|int }}
          {% else %}null{% endif %}
  - platform: rest
    name: horizon_localhost_status
    resource: 'http://localhost/status'
    method: GET
    force_update: true
    json_attributes:
     - configuration
     - connectivity
    value_template: >
      {{ now().strftime("%a %b %d @ %I:%M %p") }}
  - platform: rest
    name: horizon_agreements
    resource: 'http://localhost/agreement'
    method: GET
    force_update: true
    json_attributes:
     - agreements
    value_template: >
      {% if value_json is defined and value_json != '[]' %}
        {{ now().strftime("%a %b %d @ %I:%M %p") }}
      {% else %}null{% endif %}
  - platform: template
    sensors:
      horizon_agreement_active:
        entity_id:
          - sensor.horizon_agreements_count_active
        value_template: >
          {% if states.sensor.horizon_agreements_count_active.state|int > 0 %}
            {{ states.sensor.horizon_agreements.attributes.agreements.active[0].workload_to_run.url }}
          {% else %}null{% endif %}
      horizon_agreements_count_active:
        entity_id:
          - sensor.horizon_agreements
        value_template: >
          {% if states.sensor.horizon_agreements.attributes.agreements is defined and states.sensor.horizon_agreements.attributes.agreements.active != '[]' %}
            {{ states.sensor.horizon_agreements.attributes.agreements.active|length }}
          {% else %}null{% endif %}
      horizon_agreements_count_archived:
        entity_id:
          - sensor.horizon_agreements
        value_template: >
          {% if states.sensor.horizon_agreements.attributes.agreements is defined and states.sensor.horizon_agreements.attributes.agreements.archived != '[]' %}
            {{ states.sensor.horizon_agreements.attributes.agreements.archived|length }}
          {% else %}null{% endif %}
      horizon_exchange_api:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.exchange_api }} 
      horizon_exchange_version:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.exchange_version }} 
      horizon_required_minimum_exchange_version:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.required_minimum_exchange_version }} 
      horizon_preferred_exchange_version:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.preferred_exchange_version }} 
      horizon_architecture:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.architecture }} 
      horizon_version:
        entity_id:
          - sensor.horizon_localhost_status
        value_template: >
          {{ states.sensor.horizon_localhost_status.attributes.configuration.horizon_version }} 

###
### HZNSETUP
###

sensor hznsetup:
  - platform: mqtt
    name: hznsetup_event_nodes
    state_topic: 'hznsetup/dcmartin@us.ibm.com/status/node'
    force_update: true
    expire_after: 1
    json_attributes:
      - nodes
      - date
      - timestamp
      - exchange
      - org
      - device
      - configuration
    value_template: >
      {% if value_json is defined %} true {% else %} false {% endif %}
  ## standard event count, ago, mean, status
  - platform: template
    sensors:
      ## counting
      hznsetup_events_count:
        entity_id:
          - counter.hznsetup_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.hznsetup_event_counter is defined %}
            {{ states.counter.hznsetup_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      hznsetup_event_ago:
        entity_id:
          - sensor.hznsetup_event
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.hznsetup_event.attributes.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.hznsetup_event.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      ## mean timing
      hznsetup_event_ago_mean:
        entity_id:
          - sensor.hznsetup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.hznsetup_event_ago_statistics_mean is defined %}
            {{ states.sensor.hznsetup_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      hznsetup_event_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.hznsetup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.hznsetup_event_ago_statistics_mean is defined %}
            {{ states.sensor.hznsetup_event_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      hznsetup_event_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.hznsetup_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.hznsetup_event_ago_statistics_mean is defined %}
            {{ states.sensor.hznsetup_event_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## status
      hznsetup_event_status:
        entity_id:
          - sensor.hznsetup_event
        value_template: >-
          {% if states.sensor.hznsetup_event is defined and states.sensor.hznsetup_event.attributes.camera is defined %}
            From {{ states.sensor.hznsetup_event.attributes.device }} {{ states.sensor.hznsetup_event.attributes.camera }}
          {% else %} null {% endif %}
  ## statistics
  - platform: history_stats
    name: hznsetup_event_count
    entity_id: sensor.hznsetup_event
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: hznsetup_event_count_statistics
    entity_id: sensor.hznsetup_event_count
    max_age:
      hours: 2
  - platform: statistics
    name: hznsetup_event_ago_statistics
    entity_id: sensor.hznsetup_event_ago
    max_age:
      hours: 2
  - platform: template
    sensors:
      hznsetup_event_nodes_count:
        entity_id:
          - sensor.hznsetup_event_nodes
        unit_of_measurement: nodes
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes is defined %}
            {%- if states.sensor.hznsetup_event_nodes.attributes.nodes is defined %}
              {{ states.sensor.hznsetup_event_nodes.attributes.nodes|length }}
            {%- else %}null{% endif %}
          {%- else %}null{% endif %}
      # index nodes
      hznsetup_event_nodes_index:
        entity_id:
          - sensor.hznsetup_event_nodes
          - input_number.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 -%}
            {% set nnode = states.sensor.hznsetup_event_nodes.attributes.nodes|length %}
            {% if states.input_number.hznsetup_event_nodes_index.state|int <= nnode -%}
              {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
                {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes -%}
                  {% if loop.index == nidx %}{{ node }}{% endif %}
                {%- endfor -%}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      hznsetup_event_nodes_id:
        entity_id:
          - sensor.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 %}
            {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
              {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes %}
                {% if loop.index == nidx %}{{ node.id }}{% endif %}
              {%- endfor %}
          {%- else %}null{% endif %}
      hznsetup_event_nodes_ip:
        entity_id:
          - sensor.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 %}
            {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
              {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes %}
                {% if loop.index == nidx %}{{ node.ipv4 }}{% endif %}
              {%- endfor %}
          {%- else %}null{% endif %}
      hznsetup_event_nodes_mac:
        entity_id:
          - sensor.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 %}
            {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
              {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes %}
                {% if loop.index == nidx %}{{ node.mac }}{% endif %}
              {%- endfor %}
          {%- else %}null{% endif %}
      hznsetup_event_nodes_exchange:
        entity_id:
          - sensor.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 %}
            {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
              {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes %}
                {% if loop.index == nidx %}{{ node.exchange }}{% endif %}
              {%- endfor %}
          {%- else %}null{% endif %}
      hznsetup_event_nodes_pattern:
        entity_id:
          - sensor.hznsetup_event_nodes_index
        value_template: >
          {%- if states.sensor.hznsetup_event_nodes.attributes.nodes|length > 0 %}
            {% set nidx = states.input_number.hznsetup_event_nodes_index.state|int %}
              {%- for node in states.sensor.hznsetup_event_nodes.attributes.nodes %}
                {% if loop.index == nidx %}{{ node.pattern }}{% endif %}
              {%- endfor %}
          {%- else %}null{% endif %}

binary_sensor hznsetup_event:
  - platform: template
    sensors:
      ## state
      hznsetup_event_state:
        entity_id:
          - sensor.hznsetup_event_latest_id
          - sensor.hznsetup_event_ago
        value_template: >
          {{ states.sensor.hznsetup_event.state }}
      hznsetup_client_low:
        entity_id:
          - sensor.hznsetup_event_client_count
          - sensor.hznsetup_event_client_count_statistics_mean
          - input_number.hznsetup_client_deviation
        value_template: >-
          {% if states.sensor.hznsetup_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.hznsetup_event_client_count_statistics_mean.state|float) - (states.sensor.hznsetup_event_client_count.state|float))
                 / (states.sensor.hznsetup_event_client_count_statistics_mean.attributes.standard_deviation|float)
               > (states.input_number.hznsetup_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      hznsetup_client_low_persistent:
        entity_id:
          - sensor.hznsetup_event_client_count
          - sensor.hznsetup_event_client_count_stdev_mean
          - input_number.hznsetup_client_deviation
        value_template: >-
          {% if states.sensor.hznsetup_event_client_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.hznsetup_event_client_count_statistics_mean.state|float) - (states.sensor.hznsetup_event_client_count.state|float))
                 / (states.sensor.hznsetup_event_client_count_stdev_mean.state|float)
               > (states.input_number.hznsetup_client_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      hznsetup_client_high:
        entity_id:
          - sensor.hznsetup_event_client_count
          - sensor.hznsetup_event_client_count_statistics_mean
          - input_number.hznsetup_client_deviation
        value_template: >-
          {% if states.sensor.hznsetup_event_client_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.hznsetup_event_client_count.state|float) - (states.sensor.hznsetup_event_client_count_statistics_mean.state|float))
                 / (states.sensor.hznsetup_event_client_count_statistics_mean.attributes.standard_deviation|float))
               > (states.input_number.hznsetup_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      hznsetup_client_high_persistent:
        entity_id:
          - sensor.hznsetup_event_client_count
          - sensor.hznsetup_event_client_count_stdev_mean
          - input_number.hznsetup_client_deviation
        value_template: >-
          {% if states.input_number.hznsetup_client_deviation.state|float > 0 %}
            {{ (((states.sensor.hznsetup_event_client_count.state|float) - (states.sensor.hznsetup_event_client_count_statistics_mean.state|float))
                 / (states.sensor.hznsetup_event_client_count_stdev_mean.state|float))
               > (states.input_number.hznsetup_client_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy

###
### INTERNET TEST
###

sensor internet_test:
  - platform: command_line
    command: speedtest --json | jq '.date='$(date +%s)'|.latitude=(.client.lat|tonumber)|.longitude=(.client.lon|tonumber)'
    name: internet_test
    scan_interval: 900
    command_timeout: 60
    json_attributes:
      - server
      - latitude
      - longitude
      - bytes_sent
      - bytes_received
      - client 
      - date
      - timestamp
      - ping
      - download
      - upload 
    value_template: >
      {%- if value_json is defined -%}
        {{ value_json.date | int | timestamp_custom("%a %b %d @ %I:%M %p") }}
      {%- else -%}null{%- endif -%}
  - platform: template
    sensors:
      internet_tests_count:
        entity_id:
          - counter.internet_test_counter
        unit_of_measurement: tests
        value_template: >
          {% if states.counter.internet_test_counter is defined %}
            {{ states.counter.internet_test_counter.state|int }}
          {%- else -%}null{%- endif -%}
      internet_test_ago:
        entity_id:
          - sensor.internet_test
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.internet_test.attributes.date is defined %}
           {{ (now().timestamp()|int) - (states.sensor.internet_test.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      internet_event_status:
        entity_id:
          - sensor.internet_test
        value_template: >-
          {% if states.sensor.internet_test is defined and states.sensor.internet_test.attributes.date is defined %}
            From {{ states.sensor.internet_test.attributes.server.name }} at {{ states.sensor.internet_test.attributes.date | int | timestamp_custom("%a %b %d %I:%M %p") }}
          {% else %} null {% endif %}
      internet_test_receive:
        entity_id:
          - sensor.internet_test
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_test.attributes.download is defined and states.sensor.internet_test.attributes.download != null %}
            {{ '%0.2f' | format(states.sensor.internet_test.attributes.download|float / 1000000.0) }}
          {%- else -%}null{%- endif -%}
      internet_test_send:
        entity_id:
          - sensor.internet_test
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_test.attributes.upload is defined and states.sensor.internet_test.attributes.upload != null %}
            {{ '%0.2f' | format(states.sensor.internet_test.attributes.upload|float / 1000000.0) }}
          {%- else -%}null{%- endif -%}
      internet_receive_mean:
        entity_id:
          - sensor.internet_receive_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_receive_statistics_mean is defined %}
            {{ states.sensor.internet_receive_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      internet_receive_min_value:
        entity_id:
          - sensor.internet_receive_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_receive_statistics_mean is defined %}
            {{ states.sensor.internet_receive_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      internet_receive_max_value:
        entity_id:
          - sensor.internet_receive_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_receive_statistics_mean is defined %}
            {{ states.sensor.internet_receive_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      internet_receive_standard_deviation:
        entity_id:
          - sensor.internet_receive_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_receive_statistics_mean is defined %}
            {% if states.sensor.internet_receive_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.internet_receive_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      internet_send_mean:
        entity_id:
          - sensor.internet_send_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_send_statistics_mean is defined %}
            {{ states.sensor.internet_send_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      internet_send_min_value:
        entity_id:
          - sensor.internet_send_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_send_statistics_mean is defined %}
            {{ states.sensor.internet_send_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      internet_send_max_value:
        entity_id:
          - sensor.internet_send_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_send_statistics_mean is defined %}
            {{ states.sensor.internet_send_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      internet_send_standard_deviation:
        entity_id:
          - sensor.internet_send_statistics_mean
        unit_of_measurement: Mbps
        value_template: >
          {% if states.sensor.internet_send_statistics_mean is defined %}
            {% if states.sensor.internet_send_statistics_mean.attributes.standard_deviation != 'unknown' %}
              {{ states.sensor.internet_send_statistics_mean.attributes.standard_deviation }}
            {%- else -%}null{%- endif -%}
          {%- else -%}null{%- endif -%}
      internet_slow_count:
        entity_id:
          - sensor.internet_slow_test_count
        unit_of_measurement: tests
        value_template: >
          {% if states.sensor.internet_slow_test_count is defined %}
            {{ states.sensor.internet_slow_test_count.state }}
          {%- else -%}null{%- endif -%}
      internet_fast_count:
        entity_id:
          - sensor.internet_fast_test_count
        unit_of_measurement: tests
        value_template: >
          {% if states.sensor.internet_fast_test_count is defined %}
            {{ states.sensor.internet_fast_test_count.state }}
          {%- else -%}null{%- endif -%}
  - platform: statistics
    entity_id: sensor.internet_test_send
    name: internet_send_statistics
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.internet_test_receive
    name: internet_receive_statistics
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.internet_send_standard_deviation
    name: internet_send_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: statistics
    entity_id: sensor.internet_receive_standard_deviation
    name: internet_receive_stdev
    sampling_size: 100
    max_age:
      hours: 2
  - platform: history_stats
    name: internet_test_count
    entity_id: binary_sensor.internet_test_state
    state: on
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: internet_slow_test_count
    entity_id: binary_sensor.internet_slow
    state: on
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: history_stats
    name: internet_fast_test_count
    entity_id: binary_sensor.internet_fast
    state: on
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'

binary_sensor internet_test:
  - platform: template
    sensors:
      internet_test_state:
        entity_id:
          - sensor.internet_test
          - sensor.internet_test_ago
        value_template: >
          {% if states.sensor.internet_test_ago.state|int > 30 %}false{% else %}true{% endif %}
      internet_slow:
        entity_id:
          - sensor.internet_test_receive
          - sensor.internet_receive_statistics_mean
          - input_number.internet_deviation
        value_template: >-
          {% if states.sensor.internet_receive_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.internet_receive_mean.state|float) - (states.sensor.internet_test_receive.state|float))
                 / (states.sensor.internet_receive_statistics_mean.attributes.standard_deviation|float) 
               > (states.input_number.internet_deviation.state|float)) }}
          {%- else -%}null{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      internet_slow_persistent:
        entity_id:
          - sensor.internet_test_receive
          - sensor.internet_receive_stdev_mean
          - input_number.internet_deviation
        value_template: >-
          {% if states.sensor.internet_receive_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.internet_receive_mean.state|float) - (states.sensor.internet_test_receive.state|float))
                 / (states.sensor.internet_receive_stdev_mean.state|float) 
               > (states.input_number.internet_deviation.state|float)) }}
          {%- else -%}null{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      internet_fast:
        entity_id:
          - sensor.internet_test_receive
          - sensor.internet_receive_statistics_mean
          - input_number.internet_deviation
        value_template: >-
          {% if states.sensor.internet_receive_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.internet_test_receive.state|float) - (states.sensor.internet_receive_mean.state|float))
                 / (states.sensor.internet_receive_statistics_mean.attributes.standard_deviation|float)) 
               > (states.input_number.internet_deviation.state|float) }}
          {%- else -%}null{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      internet_fast_persistent:
        entity_id:
          - sensor.internet_test_receive
          - sensor.internet_receive_stdev_mean
          - input_number.internet_deviation
        value_template: >-
          {% if states.sensor.internet_receive_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.internet_test_receive.state|float) - (states.sensor.internet_receive_mean.state|float))
                 / (states.sensor.internet_receive_stdev_mean.state|float)) 
               > (states.input_number.internet_deviation.state|float) }}
          {%- else -%}null{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
            
###
### MOTION
###

sensor motion_sensors:
  ##
  ## GROUP START - 'motion/+/start'
  ##
  - platform: mqtt
    name: motion_configuration_network
    state_topic: 'motion/+/start'
    json_attributes:
      - unit_system
      - latitude
      - longitude
      - elevation
      - interval
      - minimum_animate
      - post_pictures
      - share_dir
      - name
      - host
      - date
      - www
      - devicedb
      - timezone
      - mqtt
      - watson
      - digits
      - motion
      - cameras
    value_template: >
      {% if value_json is defined %}true{% else %}null{% endif %}
  ##
  ## CAMERA FOUND - 'motion/+/+/status/found'
  ##
  - platform: mqtt
    name: motion_camera_found
    state_topic: 'motion/+/+/status/found'
    expire_after: 1
    force_update: true
    json_attributes:
      - device
      - camera
      - date
      - status
    value_template: >
      {% if value_json is defined %}true{% else %}null{% endif %}
  ##
  ## CAMERA LOST - 'motion/+/+/status/lost' 
  ##
  - platform: mqtt
    name: motion_camera_lost
    state_topic: 'motion/+/+/status/lost'
    expire_after: 1
    force_update: true
    json_attributes:
      - device
      - camera
      - date
      - status
    value_template: >
      {% if value_json is defined %}true{% else %}null{% endif %}
  ##
  ## EVENT IMAGE - motion/+/+/event/image
  ##
  - platform: mqtt
    name: motion_event_image
    state_topic: 'motion/+/+/event/image'
    expire_after: 1
    force_update: true
    json_attributes:
      - device
      - camera
      - type
      - date
      - seqno
      - event
      - id
      - center
      - width
      - height
      - size
      - noise
    value_template: >
      {% if value_json is defined %}true{% else %}null{% endif %}
  ## standard event count, ago, mean, status
  - platform: template
    sensors:
      ## counting
      motion_event_images_count:
        entity_id:
          - counter.motion_event_image_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.motion_event_image_counter is defined %}
            {{ states.counter.motion_event_image_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      motion_event_image_ago:
        entity_id:
          - sensor.motion_event_image
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_image.attributes.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.motion_event_image.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      ## mean ago
      motion_event_image_ago_mean:
        entity_id:
          - sensor.motion_event_image_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_image_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_image_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      motion_event_image_ago_min_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.motion_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_image_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_image_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      motion_event_image_ago_max_value:
        entity_id:
          - sensor.yolo2msghub_event
          - sensor.motion_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_image_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_image_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## status
      motion_event_image_status:
        entity_id:
          - sensor.motion_event_image
        value_template: >-
          {% if states.sensor.motion_event_image is defined and states.sensor.motion_event_image.attributes.camera is defined %}
            From {{ states.sensor.motion_event_image.attributes.device }} {{ states.sensor.motion_event_image.attributes.camera }}
          {% else %} null {% endif %}
  ## statistics
  - platform: history_stats
    name: motion_event_image_count
    entity_id: sensor.motion_event_image
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: motion_event_image_count_statistics
    entity_id: sensor.motion_event_images_count
    max_age:
      hours: 2
  - platform: statistics
    name: motion_event_image_ago_statistics
    entity_id: sensor.motion_event_image_ago
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      motion_event_image_device:
        entity_id:
          - sensor.motion_event_image
        value_template: >
          {% if states.sensor.motion_event_image is defined and states.sensor.motion_event_image.attributes.device is defined %}
            {{ states.sensor.motion_event_image.attributes.device }}
          {% else %} null {% endif %}
      motion_event_image_camera:
        entity_id:
          - sensor.motion_event_image
        value_template: >
          {% if states.sensor.motion_event_image is defined and states.sensor.motion_event_image.attributes.camera is defined %}
            {{ states.sensor.motion_event_image.attributes.camera }}
          {% else %} null {% endif %}
      motion_event_image_type:
        entity_id:
          - sensor.motion_event_image
        value_template: >
          {% if states.sensor.motion_event_image is defined and states.sensor.motion_event_image.attributes.type is defined %}
            {{ states.sensor.motion_event_image.attributes.type }}
          {% else %} null {% endif %}
      motion_event_image_center:
        entity_id:
          - sensor.motion_event_image
        value_template: >
          {% if states.sensor.motion_event_image is defined and states.sensor.motion_event_image.attributes.center is defined %}
            {{ states.sensor.motion_event_image.attributes.center }}
          {% else %} null {% endif %}
  ##
  ## EVENT (top-level) - motion/+/+/event/end
  ##
  - platform: mqtt
    name: motion_event_end
    state_topic: 'motion/+/+/event/end'
    expire_after: 1
    force_update: true
    json_attributes:
      - device
      - camera
      - event
      - start
      - end
      - elapsed
      - date
      - images
    value_template: >
      {% if value_json is defined %}true{% else %}null{% endif %}
  ## standard event count, ago, mean, status
  - platform: template
    sensors:
      ## counting
      motion_events_count:
        entity_id:
          - counter.motion_event_counter
        unit_of_measurement: events
        value_template: >
          {% if states.counter.motion_event_counter is defined %}
            {{ states.counter.motion_event_counter.state|int }}
          {%- else -%}null{%- endif -%}
      ## timing
      motion_event_ago:
        entity_id:
          - sensor.motion_event_end
          - sun.sun
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_end.attributes.date is defined %}
            {{ (now().timestamp()|int) - (states.sensor.motion_event_end.attributes.date|int) }}
          {%- else -%}null{%- endif -%}
      ## mean ago
      motion_event_ago_mean:
        entity_id:
          - sensor.motion_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_ago_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      motion_event_ago_min_value:
        entity_id:
          - sensor.motion_event
          - sensor.motion_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_ago_statistics_mean.attributes.min_value }}
          {%- else -%}null{%- endif -%}
      motion_event_ago_max_value:
        entity_id:
          - sensor.motion_event
          - sensor.motion_event_ago_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_ago_statistics_mean is defined %}
            {{ states.sensor.motion_event_ago_statistics_mean.attributes.max_value }}
          {%- else -%}null{%- endif -%}
      ## status
      motion_event_status:
        entity_id:
          - sensor.motion_event_end
        value_template: >-
          {% if states.sensor.motion_event_end is defined and states.sensor.motion_event_end.attributes.camera is defined %}
            From {{ states.sensor.motion_event_end.attributes.device }} {{ states.sensor.motion_event_end.attributes.camera }}
          {% else %} null {% endif %}
  ## statistics
  - platform: history_stats
    name: motion_event_count
    entity_id: sensor.motion_event_end
    state: 'true'
    type: count
    start: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    end: '{{ now() }}'
  - platform: statistics
    name: motion_event_count_statistics
    entity_id: sensor.motion_events_count
    max_age:
      hours: 2
  - platform: statistics
    name: motion_event_ago_statistics
    entity_id: sensor.motion_event_ago
    max_age:
      hours: 2
  ## attributes
  - platform: template
    sensors:
      motion_event_id:
        entity_id:
          - sensor.motion_event_end
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.event }}
          {% else %} null {% endif %}
      motion_device:
        entity_id:
          - sensor.motion_event_end
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.device }}
          {% else %} null {% endif %}
      motion_camera:
        entity_id:
          - sensor.motion_event_end
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.camera }}
          {% else %} null {% endif %}
      motion_when:
        entity_id:
          - sensor.motion_event_end
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.date | int | timestamp_custom("%a %b %d ~ %I:%M %p") }}
          {% else %} null {% endif %}
      motion_image_count:
        entity_id:
          - sensor.motion_event_end
        unit_of_measurement: 'images'
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.images | length }}
          {% else %} null {% endif %}
      motion_image_first:
        entity_id:
          - sensor.motion_event_end
        value_template: >-
          {% if states.sensor.motion_event_end is defined %}
            {% for image in states.sensor.motion_event_end.attributes.images %}
              {% if loop.first %} {{ image }} {% endif %}
            {% endfor %}
          {% else %} null {% endif %}
      motion_image_last:
        entity_id:
          - sensor.motion_event_end
        ##{{ (states.sensor.motion_event_end_event.attributes.images|last).state }}
        value_template: >-
          {% if states.sensor.motion_event_end is defined %}
            {% for image in states.sensor.motion_event_end.attributes.images %}
              {% if loop.last %} {{ image }} {% endif %}
            {% endfor %}
          {% else %} null {% endif %}
      motion_start:
        entity_id:
          - sensor.motion_event_end
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.start | int }}
          {% else %}null{% endif %}
      motion_end:
        entity_id:
          - sensor.motion_event_end
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.end | int }}
          {% else %}null{% endif %}
      motion_elapsed:
        entity_id:
          - sensor.motion_event_end
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.elapsed }}
          {% else %}null{% endif %}
      motion_elapsed_mean:
        entity_id:
          - sensor.motion_event_elapsed_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_elapsed_statistics_mean is defined %}
            {{ states.sensor.motion_event_elapsed_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
      motion_entity_count:
        entity_id:
          - sensor.motion_event_end
        unit_of_measurement: entity
        value_template: >
          {% if states.sensor.motion_event_end is defined %}
            {{ states.sensor.motion_event_end.attributes.entity_count }}
          {% else %}null{% endif %}
      motion_entity_count_mean:
        entity_id:
          - sensor.motion_event_entity_count_statistics_mean
        unit_of_measurement: seconds
        value_template: >
          {% if states.sensor.motion_event_entity_count_statistics_mean is defined %}
            {{ states.sensor.motion_event_entity_count_statistics_mean.state }}
          {%- else -%}null{%- endif -%}
  - platform: statistics
    name: motion_elapsed_statistics
    entity_id: sensor.motion_elapsed
    max_age:
      hours: 2
  - platform: statistics
    name: motion_entity_count_statistics
    entity_id: sensor.motion_entity_count
    max_age:
      hours: 2
  ##
  ## CONFIGURATION
  ##
  - platform: template
    sensors:
      motion_configuration_localhost_camera_count:
        entity_id:
          - sensor.motion_configuration_localhost
        value_template: >-
          {% if states.sensor.motion_configuration_localhost.attributes.cameras is defined %}
            {{ states.sensor.motion_configuration_localhost.attributes.cameras | length }}
          {% else %}null{% endif %}
      motion_configuration_localhost_camera_names:
        entity_id:
          - sensor.motion_configuration_localhost
        value_template: >-
          {% if states.sensor.motion_configuration_localhost.attributes.cameras is defined %}
            {%- for camera in states.sensor.motion_configuration_localhost.attributes.cameras -%}
              {% if loop.first %}[{% else %},{% endif %}
              {{- camera.name | tojson -}}
              {%- if loop.last -%}]{%- endif -%}
            {% endfor %}
          {% else %}null{% endif %}
      motion_configuration_network_camera_count:
        entity_id:
          - sensor.motion_configuration_network
        value_template: >-
          {% if states.sensor.motion_configuration_network.attributes.cameras is defined %}
            {{ states.sensor.motion_configuration_network.attributes.cameras | length }}
          {% else %}null{% endif %}
      motion_configuration_network_camera_names:
        entity_id:
          - sensor.motion_configuration_network
        value_template: >-
          {% if states.sensor.motion_configuration_network.attributes.cameras is defined %}
            {%- for camera in states.sensor.motion_configuration_network.attributes.cameras -%}
              {% if loop.first %}[{% else %},{% endif %}
              {{- camera.name | tojson -}}
              {%- if loop.last -%}]{%- endif -%}
            {% endfor %}
          {% else %}null{% endif %}

binary_sensor motion_event_end:
  - platform: template
    sensors:
      ## state
      motion_event_end_state:
        entity_id:
          - sensor.motion_event_device
          - sensor.motion_event_ago
        value_template: >
          {{ states.sensor.motion_event_end.state }}
      motion_entity_low:
        entity_id:
          - sensor.motion_entity_count
          - sensor.motion_entity_count_statistics_mean
          - input_number.motion_entity_deviation
        value_template: >-
          {% if states.sensor.motion_entity_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.motion_entity_count_statistics_mean.state|float) - (states.sensor.motion_entity_count.state|float))
                 / (states.sensor.motion_entity_count_statistics_mean.attributes.standard_deviation|float)
               > (states.input_number.motion_entity_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      motion_entity_low_persistent:
        entity_id:
          - sensor.motion_entity_count
          - sensor.motion_entity_count_stdev_mean
          - input_number.motion_entity_deviation
        value_template: >-
          {% if states.sensor.motion_entity_count_stdev_mean.state|float > 0 %}
            {{ (((states.sensor.motion_entity_count_statistics_mean.state|float) - (states.sensor.motion_entity_count.state|float))
                 / (states.sensor.motion_entity_count_stdev_mean.state|float)
               > (states.input_number.motion_entity_deviation.state|float)) }}
          {%- else -%}false{%- endif -%}
        icon_template: >
            mdi:emoticon-sad
      motion_entity_high:
        entity_id:
          - sensor.motion_entity_count
          - sensor.motion_entity_count_statistics_mean
          - input_number.motion_entity_deviation
        value_template: >-
          {% if states.sensor.motion_entity_count_statistics_mean.attributes.standard_deviation|float > 0 %}
            {{ (((states.sensor.motion_entity_count.state|float) - (states.sensor.motion_entity_count_statistics_mean.state|float))
                 / (states.sensor.motion_entity_count_statistics_mean.attributes.standard_deviation|float))
               > (states.input_number.motion_entity_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy
      motion_entity_high_persistent:
        entity_id:
          - sensor.motion_entity_count
          - sensor.motion_entity_count_stdev_mean
          - input_number.motion_entity_deviation
        value_template: >-
          {% if states.input_number.motion_entity_deviation.state|float > 0 %}
            {{ (((states.sensor.motion_entity_count.state|float) - (states.sensor.motion_entity_count_statistics_mean.state|float))
                 / (states.sensor.motion_entity_count_stdev_mean.state|float))
               > (states.input_number.motion_entity_deviation.state|float) }}
          {%- else -%}false{%- endif -%}
        icon_template: >-
            mdi:emoticon-happy

## MOTION CAMERAS
camera motion_cameras:
  # last camera (varies)
  - platform: mqtt
    name: motion_last_image
    topic: 'motion/+/+/image'
  - platform: mqtt
    name: motion_last_average
    topic: 'motion/+/+/image-average'
  - platform: mqtt
    name: motion_last_blend
    topic: 'motion/+/+/image-blend'
  - platform: mqtt
    name: motion_last_animated_mask
    topic: 'motion/+/+/image-animated-mask'
  - platform: mqtt
    name: motion_last_composite
    topic: 'motion/+/+/image-composite'
  - platform: mqtt
    name: motion_last_animated
    topic: 'motion/+/+/image-animated'
  - platform: mqtt
    name: motion_last_annotated
    topic: 'motion/+/+/image/+'
  - platform: mqtt
    name: motion_last_cropped
    topic: 'motion/+/+/image-cropped'
  # camera1
  - platform: mqtt
    name: motion_camera1_image
    topic: 'motion/nano-1/+/image'
  - platform: mqtt
    name: motion_camera1_image_annotated
    topic: 'motion/nano-1/+/image/+'
  - platform: mqtt
    name: motion_camera1_image_animated
    topic: 'motion/nano-1/+/image-animated'
  # camera2
  - platform: mqtt
    name: motion_camera2_image
    topic: 'motion/nano-2/+/image'
  - platform: mqtt
    name: motion_camera2_image_annotated
    topic: 'motion/nano-2/+/image/+'
  - platform: mqtt
    name: motion_camera2_image_animated
    topic: 'motion/nano-2/+/image-animated'
  # camera3
  - platform: mqtt
    name: motion_camera3_image
    topic: 'motion/pi3-1/+/image'
  - platform: mqtt
    name: motion_camera3_image_annotated
    topic: 'motion/pi3-1/+/image/+'
  - platform: mqtt
    name: motion_camera3_image_animated
    topic: 'motion/pi3-1/+/image-animated'
  # camera 4
  - platform: mqtt
    name: motion_camera4_image
    topic: 'motion/pi3-2/+/image'
  - platform: mqtt
    name: motion_camera4_image_annotated
    topic: 'motion/pi3-2/+/image/+'
  - platform: mqtt
    name: motion_camera4_image_animated
    topic: 'motion/pi3-2/+/image-animated'
  # camera 6
  - platform: mqtt
    name: motion_camera5_image
    topic: 'motion/pi3-3/+/image'
  - platform: mqtt
    name: motion_camera5_image_annotated
    topic: 'motion/pi3-3/+/image/+'
  - platform: mqtt
    name: motion_camera5_image_animated
    topic: 'motion/pi3-3/+/image-animated'
  # gate
  - platform: mqtt
    name: motion_gate_image
    topic: 'motion/+/gate/image'    
  - platform: mqtt
    name: motion_gate_image_annotated
    topic: 'motion/+/gate/image/+'    
  - platform: mqtt
    name: motion_gate_image_animated
    topic: 'motion/+/gate/image-animated'    
  # road
  - platform: mqtt
    name: motion_road_image
    topic: 'motion/+/road/image'
  - platform: mqtt
    name: motion_road_image_annotated
    topic: 'motion/+/road/image/+'
  - platform: mqtt
    name: motion_road_image_animated
    topic: 'motion/+/road/image-animated'
